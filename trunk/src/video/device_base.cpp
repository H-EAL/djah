#include "video/device_base.hpp"
#include "video/drivers/opengl_driver.hpp"

namespace djah { namespace video {

	//----------------------------------------------------------------------------------------------
	device_ptr create_device(const video_config &cfg)
	{
		device_ptr device = new_platform_specific_device();
		driver_ptr driver = new drivers::opengl_driver(device);
		device->setVideoDriver(driver);
		device->create(cfg);
		return device;
	}
	//----------------------------------------------------------------------------------------------
	device_ptr create_device(int width, int height,
							 int colorBits, int depthBits, int stencilBits,
							 bool fullscreen, bool vsync)
	{
		return create_device( video_config(width, height, colorBits, depthBits, stencilBits, fullscreen, vsync) );
	}
	//----------------------------------------------------------------------------------------------




	//----------------------------------------------------------------------------------------------
	device_ptr device_base::s_device_inst_ = 0;
	//----------------------------------------------------------------------------------------------

	//----------------------------------------------------------------------------------------------
	device_ptr device_base::get_current()
	{
		return s_device_inst_;
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	device_base::device_base()
		: hasToQuit_(false)
		, driver_(0)
	{
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	device_base::~device_base()
	{
		delete driver_;
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	const video_config& device_base::videoConfig() const
	{
		return video_config_;
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	void device_base::setVideoDriver(driver_ptr driver)
	{
		driver_ = driver;
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	driver_ptr device_base::videoDriver() const
	{
		return driver_;
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	void device_base::create(const video_config &cfg)
	{
		s_device_inst_ = this;
		video_config_ = cfg;
		createImpl();
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	void device_base::destroy()
	{
		s_device_inst_ = 0;
		driver_->destroy();
		destroyImpl();
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	bool device_base::run()
	{
		return !hasToQuit_ && runImpl();
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	void device_base::shutDown()
	{
		hasToQuit_ = true;
	}
	//----------------------------------------------------------------------------------------------


	//----------------------------------------------------------------------------------------------
	void device_base::resize(int width, int height)
	{
		driver_->setViewport(geometry::rect_i(0,0,width,height));
	}
	//----------------------------------------------------------------------------------------------

} /*video*/ } /*djah*/